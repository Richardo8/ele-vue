# 店铺列表页构建过程

1. 添加代理

    在`/config/index.js`中的dev环境添加代理：

        proxyTable: {
              '/shopping': {
                target: 'https://mainsite-restapi.ele.me',
                changeOrigin: true
              },
            },

2. 新建组件

    在`src/components/commond`目录下新建一个组件`storeList`,

        <template>
          <div></div>
        </template>

        <script>
          import {getStoreList} from '../../../src/service/getData'

          export default {
              data(){
                  return {
                    offset: 0,
                    shopListArr:[]
                  }
              },
              mounted(){
                  this.initData()
              },
              methods:{
                  async initData(){
                      let res = await getStoreList('39.996369', '116.500778', this.offset);
                      console.log(res)
                      this.shopListArr = [...res]
                      console.log(this.shopListArr)
                  }
              }
          }
        </script>

    import引入组件的路径问题暂未解决

    该问题是由于webpack配置而引发的，在`webpack.base.conf.js`中，resolve下的alias是给目录进行别名设置的，在这个项目中，src目录的别名被设置为@，所以直接@/XXX/XXX即可。

3. 在APP.vue中引入该组件

    在`/src`目录下的`App.vue`中，

        <template>
          <div id="app">
            <img src="./assets/logo.png">
            <router-view></router-view>
            <storeList></storeList>//添加该行
          </div>
        </template>

        <script>
          import storeList from './components/commond/storeList.vue'
        export default {
          name: 'app',
          components: {
                  storeList //引入组件
          }
        }
        </script>


4. 新建getData文件获取数据

    在`src`目录下新建`service`目录并且新建js文件，里边存放获取数据的一系列方法。fetch方法获取的数据一定要res.json()之后才能正常使用

        let getStoreList = (latitude, longitude, offset, restaurant_category_id = '', restaurant_category_ids = '', order_by = '', delivery_mode = '', support_ids = []) => {
          let supportStr = '';
          support_ids.forEach(item => {
            if (item.status) {
              supportStr += '&support_ids[]=' + item.id;
            }
          });
          let data = {
            latitude,
            longitude,
            offset,
            limit: '20',
            'extras[]': 'activities',
            keyword: '',
            restaurant_category_id,
            'restaurant_category_ids[]': restaurant_category_ids,
            order_by,
            'delivery_mode[]': delivery_mode + supportStr
          };
          return dataJson(data)
        };

5. 增加路由

    在main.js中增加路由的配置

        import Vue from 'vue'
        import App from './App'
        import VueRouter from 'vue-router'

        Vue.use(VueRouter);

        import storeList from '@/components/commond/storeList'

        const router = new VueRouter({
          mode: 'history',
          base: __dirname,
          routes: [
            {
              path: '/',
              component: storeList
            },
            {
              path: 'storelist',
              component: storeList
            },
            {
              path: '*',
              component: storeList
            }
          ]
        })

        Vue.config.productionTip = false

        /* eslint-disable no-new */
        const app = new Vue({
          router: router,
          render: h => h(App)
        }).$mount('#app')

    注意import Router的时候要修改成vue-router，否则会报错。

    同时要将App.vue中的一些内容删除掉，否则列表会出现两次

6. 将路由转移到router目录下

    将路由转到router目录下，做到不污染main.js文件

7. 商铺根据顺序排列出来

    在main.js中引入element-ui并且全局使用：

        import ElementUI from 'element-ui'
        import 'element-ui/lib/theme-default/index.css'

        Vue.use(ElementUI);

    然后在storeList.vue中添加内容：

        <ul>
              <li v-for="item in shopListArr">
                <section>
                  <img src="">
                </section>
                <hgroup>
                  <header>
                    <h4>{{item.name}}</h4>
                    <ul>
                      <li v-for="item in item.supports">
                        {{item.icon_name}}
                      </li>
                    </ul>
                  </header>
                  <h5>
                    <section>
                      <section>
                        <el-rate disabled text-color="#ff9900" v-model="item.rating"></el-rate>
                        <span>{{item.rating}}</span>
                      </section>
                      <section>
                        月售{{item.recent_order_num}}单
                      </section>
                    </section>
                    <section v-if="item.delivery_mode">
                      <span>{{item.delivery_mode.text}}</span>
                      <span>准时达</span>
                    </section>
                  </h5>
                  <h5>
                    <section>
                      ￥{{item.float_minimum_order_amount}}起送
                      <span>/</span>
                      {{item.piecewise_agent_fee.tips}}
                    </section>
                    <section>
                      <span>{{item.distance > 1000 ? (item.distance/1000).toFixed(2) + 'km' : item.distance + 'm'}}
                        <span>/</span>
                      </span>
                      <span>{{item.order_lead_time}}</span>
                    </section>
                  </h5>
                </hgroup>
              </li>
            </ul>

    注意评分的插件el-rate，评分的数值使用v-model="item.rating"

8. 如何使用SCSS

    在package.json中添加：

        "node-sass": "^4.5.1",
        "sass": "^0.5.0",
        "sass-loader": "^6.0.3",
        "scss": "^0.2.4",
        "scss-loader": "^0.0.1",

    然后在storeList.vue中添加样式：

        <style lang="scss" scoped>
          @import 'src/style/mixin';
          .shopList_container{
            background-color: #fff;
            padding-bottom: 2rem;
          }
          .shop_li{
            display: flex;
            border-bottom: 0.025rem solid #f1f1f1;
            padding: 0.7rem 0.4rem;
          }
          .shop_img{
            @include wh(2.7rem, 2.7rem);
            display: block;
            margin-right: 0.4rem;
          }
        </style>

    wh是一个写在mixin.scss中的方法，类似于js的引入包和方法。

9. 增加样式

10. 使用mixin实现获取图片路径

    新建mixins.vue文件，并添加代码：

        <script>
          export const getPicUrl = {
            methods: {
              getPicUrl:function (url) {
                const imgBaseUrl = 'https://fuss10.elemecdn.com';
                let suffix;
                if(!url){
                  return 'http://test.fe.ptdev.cn/elm/elmlogo.jpeg'
                }
                if (url.indexOf('jpeg') !== -1) {
                  suffix = '.jpeg'
                } else {
                  suffix = '.png'
                }
                let new_url = '/' + url.substr(0, 1) + '/' + url.substr(1, 2) + '/' + url.substr(3) + suffix;
                return imgBaseUrl + new_url;
              }
            }
          }

        </script>

    在storeList.vue中先引入该对象，尤其注意的是在mixins.vue中写的是一个对象，混合本身是一个对象，所以在引入的时候需要加上{}，然后改写代码：

          import {getPicUrl} from '@/components/commond/mixins'

          mixins: [getPicUrl],

      然后在DOM结构中修改图片路径：

          <img :src="getPicUrl(item.image_path)" class="shop_img">


11. 下滑加载

    实现下滑触发事件，mixins.js中写出下滑的方法：

        export const loadMore = {
              directives: {
                  'load-more': {
                      bind: (el, binding) => {
                          console.log(el)
                          let windowHeight = window.screen.height;
                          let heightEl = el;
                          let scrollEl = document.body;
                          let height;
                          let setTop;
                          let paddingBottom;
                          let marginBottom;
                          let oldScrollTop;
                          let requestFrame;
                          let scrollReduce = 2;

                          el.addEventListener('touchstart', () => {
                              height = heightEl.clientHeight;
                              setTop = el.offsetTop;
                              paddingBottom = getStyle(el, 'paddingBottom');
                              marginBottom = getStyle(el, 'marginBottom');
                          }, false)

                        el.addEventListener('touchmove', () => {
                            loadMore();
                        }, false)

                        el.addEventListener('touchend', () => {
                            oldScrollTop = scrollEl.scrollTop;
                            moveEnd();
                        })

                        const moveEnd = () => {
                            requestFrame = requestAnimationFrame(() => {
                              if(scrollEl.scrollTop != oldScrollTop){
                                  oldScrollTop = scrollEl.scrollTop;
                                  moveEnd();
                              }else{
                                  cancelAnimationFrame(requestFrame);
                                  height = heightEl.clientHeight;
                                  loadMore();
                              }
                            })
                        }

                        const loadMore = () => {
                              if(scrollEl.scrollTop + windowHeight >= height + setTop + paddingBottom + marginBottom - scrollReduce){
                                binding.value();
                              }
                        }
                      }
                  }
              }
          }

    其中的getStyle方法引用的mUtils的方法。

    在index.html中添加\<meta\>标签:

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
            <meta name="screen-orientation" content="portrait"/>
            <meta name="apple-mobile-web-app-capable" content="yes">
            <meta name="format-detection" content="telephone=no">
            <meta name="full-screen" content="yes">
            <meta name="x5-fullscreen" content="true">

    之后网页的内容就会自适应手机屏幕。

    在storeList.vue中添加方法和触发事件：

        async loadMoreRes(){
                      if(this.preventRepeatRequest){
                          return false;
                      }
                      this.preventRepeatRequest = true;

                      this.offset += 20;
                      let res = await getStoreList('39.996369', '116.500778', this.offset);
                      this.shopListArr = [...this.shopListArr, ...res];
                      if(res.length < 20){
                          return
                      }
                      this.preventRepeatRequest = false;
                  }

    注意该方法中一定要加this.preventRepeatRequest=true,否则会出现多次加载的问题。写出方法之后，要在页面中合适的位置触发：

        <ul v-load-more="loadMoreRes">

    同时将loadMore引入到该文件的mixin中；

12. 添加loading遮罩层

    由于引入了element-ui，所以直接在html中添加：

         v-loading.fullscreen.lock="isLoading" element-loading-text="拼命加载中"

    即可，需要注意的是只有全屏模式loading标签才会在屏幕中央，lock可以在loading的时候锁住页面，不允许滑动。

    之后需要在属性中添加isLoading属性，改属性是一个boolean值，true则显示loading，false则隐藏，页面初始化时该值即为true，initData方法中初始化完毕后需要赋值为false，页面加载时需要赋值为true，加载完毕赋值为false。

